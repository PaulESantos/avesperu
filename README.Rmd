---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# avesperu <a href='https://github.com/PaulESantos/avesperu'><img src='man/figures/avesperu.svg' align="right" height="200" width="200" /></a>


<!-- badges: start -->
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-green.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
[![CRAN status](https://www.r-pkg.org/badges/version/avesperu)](https://CRAN.R-project.org/package=avesperu)
[![R-CMD-check](https://github.com/PaulESantos/avesperu/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/PaulESantos/avesperu/actions/workflows/R-CMD-check.yaml)
[![](http://cranlogs.r-pkg.org/badges/grand-total/avesperu?color=green)](https://cran.r-project.org/package=avesperu)
[![](http://cranlogs.r-pkg.org/badges/last-week/avesperu?color=green)](https://cran.r-project.org/package=avesperu)
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
<!-- badges: end -->

The `avesperu` package provides access to the most up-to-date and comprehensive dataset on Peru's avian diversity. As of **September 29, 2025**, the list includes **1,917** bird species, reflecting significant taxonomic changes and updated validations based on recent scientific publications, photographs, and sound recordings deposited in accredited institutions. The classification follows the guidelines set by the South American Checklist Committee (SACC).

### Species Categories

Each species in the dataset is classified into one of the following categories, reflecting its status in Peru:

- X Resident: 1,545 species
- E Endemic: 120 species
- NB Migratory (non-breeding): 140 species
- V Vagrant: 85 species
- IN Introduced: 3 species
- EX Extirpated: 0 species
- H Hypothetical: 23 species
- P : 2 species

This results in a total of 1,917 species, showcasing Peru's extraordinary bird diversity and the ongoing refinement of its avifaunal checklist.

## Features

The `avesperu` package is designed to streamline access to this data for researchers, conservationists, and bird enthusiasts alike. It provides:

- A comprehensive and updated bird species dataset following the latest SACC classification.

- Taxonomy validation tools, ensuring consistency with international standards.

- Fuzzy matching capabilities for improved species name retrieval and validation.


```{r echo=FALSE}
tibble::tibble(year = c(1968, 1980, 2001, 2007, 
                        2010, 2015, 2020, 2021,
                        2022, 2023, 2024, 2025),
               species = c(1491, 1678, 1800, 1800, 
                           1820, 1851, 1870, 1874, 
                           1888, 1892, 1909, 1917)) |> 
  ggplot2::ggplot(ggplot2::aes(year,
             species)) +
  ggplot2::geom_line(ggplot2::aes(group = 1)) +
  ggplot2::geom_point(color = "red") +
  ggplot2::labs(x = "",
       y = "Number of species") +
  ggplot2::scale_x_continuous(guide = ggplot2::guide_axis(n.dodge = 2),
  breaks = c(1968, 1980, 2001, 2007, 
                        2010, 2015, 2020, 2021,
                        2022, 2023, 2024, 2025),
  labels = c(1968, 1980, 2001, 2007, 
                        2010, 2015, 2020, 2021,
                        2022, 2023, 2024, 2025)) +
  ggplot2::theme_bw() +
  ggplot2::coord_flip()
```


### Insights and Trends

The chart shows the steady increase in the number of bird species recorded in Peru from 1968 to 2025, reflecting continuous research and improvements in taxonomic resolution:

- A substantial jump occurred between 1968 and 1980, with 187 new species recorded.

- In recent years, updates have slowed but continued to increase steadily, reflecting meticulous reviews of published records and taxonomic refinements.

### Categorical Summary

- Most species are resident (X), accounting for 1,545 species.

- Endemic species (E) have increased to 120, reinforcing Peru’s status as a center of avian endemism.

- The hypothetical category (H) includes 23 species, pending stronger evidence for full inclusion.

## Suggested citation:

```{r}
citation("avesperu")
```

## Installation

You can install the `avesperu` package from CRAN using:

```r
install.packages("avesperu")
# or
pak::pak("avesperu")
```

Also you can install the development version of `avesperu` like so:

``` r
pak::pak("PaulESantos/avesperu")
```

## Usage

### Basic Search
The `search_avesperu()` function accepts a character vector of species names and returns their status information from the Peru bird database. The function is fully vectorized, allowing efficient batch processing of multiple species simultaneously.


```{r}

library(avesperu)

# Define species list
splist <- c("Falco sparverius",
            "Tinamus osgoodi",
            "Phoenicoparrus jamesi",
            "Crypturellus soui",
            "Thraupis palmarum",
            "Thamnophilus praecox",
            "Penelope albipennis")

# Search for species information
search_avesperu(splist = splist)
```


### Integration with Data Frames

The function integrates seamlessly with data.frame and tibble objects, enabling efficient taxonomic validation within data processing pipelines:

```{r}
# Create a data frame with species names
bird_data <- tibble::tibble(species = splist)

# Add taxonomic information
bird_data |> 
  dplyr::mutate(taxonomy = search_avesperu(species)) 

# Or extract specific fields
bird_data  |> 
  dplyr::mutate(
    status = search_avesperu(species, return_details = TRUE)$status,
    family = search_avesperu(species, return_details = TRUE)$family_name,
    order = search_avesperu(species, return_details = TRUE)$order_name
  )
```

### Fuzzy Matching for Name Variations

The package implements approximate string matching (fuzzy matching) to handle typographical errors, spelling variations, and incomplete names. This feature significantly improves data quality when working with field observations or legacy datasets that may contain inconsistencies.

-  How Fuzzy Matching Works
The max_distance parameter controls the matching tolerance:

Values between 0 and 1 (e.g., 0.1): Interpreted as a proportion of the name length

  "Tinamus osgoodi" (14 chars): allows up to 1 character difference (14 × 0.1)

Integer values (e.g., 2): Interpreted as absolute number of character differences allowed

```{r}
# Species list with intentional typos
splist_typos <- c(
  "Falco sparverius",      # Correct
  "Tinamus osgodi",        # Missing 'o' should match "Tinamus osgoodi"
  "Crypturellus sooui",    # Extra 'o' should match "Crypturellus soui"
  "Tinamus guttatus",      # Correct
  "Tinamus guttattus",     # Extra 't' should match "Tinamus guttatus"
  "Thamnophilus praecox",  # Correct
  "Penelope albipenis"     # Missing 'n' should match "Penelope albipennis"
)

# Search with moderate tolerance (5% of name length)
results <- search_avesperu(splist_typos, max_distance = 0.05, return_details = TRUE)

# Display matching results
results[, c("name_submitted", "accepted_name", "dist")]
```


### Understanding the Output

- name_submitted: The original name provided by the user
- accepted_name: The matched species name from the database
- dist: Levenshtein distance (number of single-character edits required to transform one string into another)

  - 0 = exact match
  - 1 = one character difference (insertion, deletion, or substitution)
  - Higher values indicate greater divergence

### Adjusting Matching Sensitivity

```{r}
# Strict matching: only 1 character difference allowed
search_avesperu(splist_typos, max_distance = 1, return_details = TRUE)

# Proportional matching: 10% of name length
search_avesperu(splist_typos, max_distance = 0.1, return_details = TRUE)

# Lenient matching: up to 2 character differences
search_avesperu(splist_typos, max_distance = 2, return_details = TRUE)

# Exact matching only
search_avesperu(splist_typos, max_distance = 0, return_details = TRUE)
```



### Best Practices

Start conservative: Use max_distance = 0.05 (5%) for initial data cleaning
Review ambiguous matches: Check entries with dist > 0 to verify correctness
Handle unmatched species: Names returning NA require manual verification
Document your threshold: Always report the max_distance parameter used

- Handling Unmatched Names

```{r}
results <- search_avesperu(splist_typos, 
                           max_distance = 0,
                           return_details = TRUE)
results

# Identify unmatched species
unmatched <- results[is.na(results$accepted_name), ]
unmatched
if (nrow(unmatched) > 0) {
  cat("The following names could not be matched:\n")
  print(unmatched$name_submitted)
  
  # Try with higher tolerance
  retry <- search_avesperu(unmatched$name_submitted,
                           max_distance = 0.15,
                           return_details = TRUE )
  retry
  print(retry)
}

```


### Advanced Usage Examples 
#### Example 1: Quality Control for Field Data

```{r}
# Simulated field observation data
field_data <- data.frame(
  observer = c("Observer A", "Observer B", "Observer A", "Observer C"),
  species = c("Amazilia amazilia", "Phaetornis guy", "Metallura tyrianthina", 
              "Tangara chilensis"),
  count = c(2, 1, 3, 5)
)

# Validate species names and add taxonomy
field_data_validated <- field_data  |> 
  dplyr::mutate(
  taxonomy = purrr::map(species, ~search_avesperu(.x, 
                                           max_distance = 0.1, 
                                           return_details = TRUE))) |> 
  tidyr::unnest(taxonomy) |> 
  dplyr::select(observer, species, accepted_name, family_name, 
         english_name, status, count, dist)

field_data_validated
```

#### Example 2: Checking Endemic Status

```{r}
# Identify endemic species from a list
my_species <- c("Penelope albipennis", "Xenoglaux loweryi", "Grallaria ridgelyi",
                "Falco sparverius", "Thraupis palmarum")

results <- search_avesperu(my_species, return_details = TRUE)

# Filter endemic species
endemic_species <- results  |> 
  dplyr::filter(status == "Endémico")  |> 
  dplyr::select(scientific_name = accepted_name, english_name, family_name)

print(endemic_species)
```


#### Example 3: Taxonomic Summary

```{r}
# Get taxonomic distribution of a species list
my_list <- search_avesperu(splist, return_details = TRUE)

# Count by family
my_list  |> 
  dplyr::count(family_name, sort = TRUE)

# Count by order
my_list  |> 
  dplyr::count(order_name, sort = TRUE)

# Status summary
my_list  |> 
  dplyr::count(status)
```

